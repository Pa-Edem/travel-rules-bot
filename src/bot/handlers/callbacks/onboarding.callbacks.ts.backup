// src/bot/handlers/callbacks/onboarding.callbacks.ts

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback queries –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
 *
 * Callback query - —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç inline –∫–Ω–æ–ø–∫—É
 */

import { BotContext } from '../../../types/index.js';
import { userRepository } from '../../../database/repositories/UserRepository.js';
import {
  createDisclaimerKeyboard,
  createFullDisclaimerKeyboard,
  createMainMenuKeyboard,
} from '../../keyboards/onboarding.keyboards.js';

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ö–†–ê–¢–ö–ò–ô disclaimer
 */
export async function handleLanguageSelection(ctx: BotContext) {
  const callbackData = ctx.callbackQuery?.data;
  const userId = ctx.from?.id;

  if (!callbackData || !userId) return;

  const selectedLang = callbackData === 'lang_en' ? 'en' : 'ru';

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —è–∑—ã–∫ –≤ –ë–î
  await userRepository.update(userId, {
    language_code: selectedLang,
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é
  if (!ctx.session) ctx.session = {};
  ctx.session.onboarding_step = 'disclaimer';

  await ctx.answerCallbackQuery();
  await ctx.deleteMessage();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ö–†–ê–¢–ö–ò–ô disclaimer
  const disclaimerText =
    selectedLang === 'ru'
      ? `‚ö†Ô∏è –ü—Ä–∞–≤–æ–≤–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞\n\n–≠—Ç–æ—Ç –±–æ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–æ–Ω–∞—Ö –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö.\n\n‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω–æ–π –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.`
      : `‚ö†Ô∏è Legal Disclaimer\n\nThis bot provides general information about laws and regulations for informational purposes only.\n\n‚ö†Ô∏è Information may be incomplete or outdated. Always verify with official sources.`;

  await ctx.reply(disclaimerText, {
    reply_markup: createDisclaimerKeyboard(selectedLang),
  });
}

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è disclaimer
 * Callback data: 'disclaimer_accept'
 */
export async function handleDisclaimerAccept(ctx: BotContext) {
  const userId = ctx.from?.id;
  if (!userId) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
  await userRepository.update(userId, {
    onboarding_done: true,
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é
  if (!ctx.session) ctx.session = {};
  ctx.session.onboarding_step = 'completed';

  await ctx.answerCallbackQuery();
  await ctx.deleteMessage();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º welcome —ç–∫—Ä–∞–Ω + –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  const lang = (await userRepository.findById(userId))?.language_code === 'ru' ? 'ru' : 'en';

  const welcomeText =
    lang === 'ru'
      ? `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –≤ 6 —Å—Ç—Ä–∞–Ω–∞—Ö:\n\nüáÆüáπ –ò—Ç–∞–ª–∏—è\nüáπüá∑ –¢—É—Ä—Ü–∏—è\nüá¶üá™ –û–ê–≠\nüáπüá≠ –¢–∞–∏–ª–∞–Ω–¥\nüá™üá∏ –ò—Å–ø–∞–Ω–∏—è\nüá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –º–µ–Ω—é –Ω–∏–∂–µ:`
      : `üéâ Welcome!\n\nYou can now browse travel rules for 6 countries:\n\nüáÆüáπ Italy\nüáπüá∑ Turkey\nüá¶üá™ UAE\nüáπüá≠ Thailand\nüá™üá∏ Spain\nüá©üá™ Germany\n\nChoose an action from the menu below:`;

  const menuTitle = lang === 'ru' ? '\n\nüìã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é' : '\n\nüìã Main Menu';

  await ctx.reply(welcomeText + menuTitle, {
    reply_markup: createMainMenuKeyboard(lang),
  });
}

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è disclaimer
 * Callback data: 'disclaimer_decline'
 */
export async function handleDisclaimerDecline(ctx: BotContext) {
  const userId = ctx.from?.id;
  if (!userId) return;

  await ctx.answerCallbackQuery();
  await ctx.deleteMessage();

  const lang = (await userRepository.findById(userId))?.language_code === 'ru' ? 'ru' : 'en';

  const declineText =
    lang === 'ru'
      ? '–ñ–∞–ª—å, —á—Ç–æ –≤—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.'
      : 'Sorry you declined. Use /start to begin again.';

  await ctx.reply(declineText);
}

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç disclaimer
 * Callback data: 'disclaimer_read_full'
 */
export async function handleDisclaimerReadFull(ctx: BotContext) {
  const userId = ctx.from?.id;
  if (!userId) return;

  const lang = (await userRepository.findById(userId))?.language_code === 'ru' ? 'ru' : 'en';

  await ctx.answerCallbackQuery();
  await ctx.deleteMessage();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
  const fullText =
    lang === 'ru'
      ? `üìã **–ü–û–õ–ù–ê–Ø –ü–†–ê–í–û–í–ê–Ø –û–ì–û–í–û–†–ö–ê**\n\n**1. –•–∞—Ä–∞–∫—Ç–µ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏**\nTravel Rules Bot –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–æ–Ω–∞—Ö, –ø—Ä–∞–≤–∏–ª–∞—Ö –∏ –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –Ω–æ—Ä–º–∞—Ö —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö.\n\n**2. –ù–µ —è–≤–ª—è–µ—Ç—Å—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π**\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —ç—Ç–æ–º –±–æ—Ç–µ –ù–ï —è–≤–ª—è–µ—Ç—Å—è:\n‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π\n‚Ä¢ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º\n‚Ä¢ –ó–∞–º–µ–Ω–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–∞\n\n**3. –¢–æ—á–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å**\n‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω–æ–π –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π\n‚Ä¢ –ó–∞–∫–æ–Ω—ã –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ\n‚Ä¢ –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\n‚Ä¢ –ú—ã –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n\n**4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**\n–ò—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ—Ç –±–æ—Ç, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —á—Ç–æ:\n‚Ä¢ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n‚Ä¢ –í—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n‚Ä¢ –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫\n\n**5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö –ø–æ—Å–æ–ª—å—Å—Ç–≤\n‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å —é—Ä–∏—Å—Ç–∞–º–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏ –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∑–∞–∫–æ–Ω–æ–≤\n\n–ò—Å–ø–æ–ª—å–∑—É—è –±–æ—Ç, –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –≤—Å–µ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.`
      : `üìã **FULL LEGAL DISCLAIMER**\n\n**1. Nature of Information**\nTravel Rules Bot provides general information about laws, regulations, and cultural norms of various countries for informational purposes only.\n\n**2. Not Legal Advice**\nInformation in this bot is NOT:\n‚Ä¢ Legal advice\n‚Ä¢ Official guidance\n‚Ä¢ A substitute for professional counsel\n\n**3. Accuracy and Currency**\n‚Ä¢ Information may be incomplete or outdated\n‚Ä¢ Laws change regularly\n‚Ä¢ Always verify information from official sources\n‚Ä¢ We do not guarantee accuracy\n\n**4. Limitation of Liability**\nBy using this bot, you agree that:\n‚Ä¢ Developers are not responsible for any consequences of using this information\n‚Ä¢ You independently verify all information\n‚Ä¢ You use information at your own risk\n\n**5. Recommendations**\n‚Ä¢ Verify information on official embassy websites\n‚Ä¢ Consult with lawyers when necessary\n‚Ä¢ Monitor news about law changes\n\nBy using the bot, you accept all the above terms.`;

  await ctx.reply(fullText, {
    reply_markup: createFullDisclaimerKeyboard(lang),
    parse_mode: 'Markdown',
  });
}

/**
 * –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—Ä–∞—Ç–∫–æ–º—É disclaimer
 * Callback data: 'disclaimer_back'
 */
export async function handleDisclaimerBack(ctx: BotContext) {
  const userId = ctx.from?.id;
  if (!userId) return;

  const lang = (await userRepository.findById(userId))?.language_code === 'ru' ? 'ru' : 'en';

  await ctx.answerCallbackQuery();
  await ctx.deleteMessage();

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π disclaimer —Å–Ω–æ–≤–∞
  const disclaimerText =
    lang === 'ru'
      ? `‚ö†Ô∏è –ü—Ä–∞–≤–æ–≤–∞—è –æ–≥–æ–≤–æ—Ä–∫–∞\n\n–≠—Ç–æ—Ç –±–æ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–æ–Ω–∞—Ö –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö.\n\n‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω–æ–π –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.`
      : `‚ö†Ô∏è Legal Disclaimer\n\nThis bot provides general information about laws and regulations for informational purposes only.\n\n‚ö†Ô∏è Information may be incomplete or outdated. Always verify with official sources.`;

  await ctx.reply(disclaimerText, {
    reply_markup: createDisclaimerKeyboard(lang),
  });
}
